AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Yorutsuke Lambda Local Testing with Azure Document Intelligence

  Tests the instant-processor Lambda with Azure DI, Textract, and Bedrock models

  '
Globals:
  Function:
    Timeout: 120
    MemorySize: 512
    Runtime: nodejs20.x
    Architectures:
    - arm64
    Environment:
      Variables:
        AZURE_DI_ENDPOINT:
          Fn::Env: AZURE_DI_ENDPOINT
        AZURE_DI_API_KEY:
          Fn::Env: AZURE_DI_API_KEY
        AWS_REGION: us-east-1
Resources:
  SharedLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: yorutsuke-shared-layer
      Description: Shared utilities for Yorutsuke Lambda functions
      ContentUri: ../../../../infra/lambda/shared-layer/nodejs
      CompatibleRuntimes:
      - nodejs20.x
      CompatibleArchitectures:
      - arm64
  InstantProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: yorutsuke-instant-processor-local
      Description: Multi-model receipt analyzer with Azure DI
      CodeUri: InstantProcessorFunction
      Handler: index.handler
      Layers:
      - Ref: SharedLayer
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - s3:GetObject
          Resource: arn:aws:s3:::yorutsuke-images-*/*
        - Effect: Allow
          Action:
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          Resource: arn:aws:dynamodb:*:*:table/yorutsuke-*
        - Effect: Allow
          Action:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: arn:aws:logs:*:*:*
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          Resource: arn:aws:bedrock:*:*:foundation-model/*
    Metadata:
      SamResourceId: InstantProcessorFunction
Outputs:
  InstantProcessorFunctionArn:
    Description: ARN of Instant Processor Function
    Value:
      Fn::GetAtt:
      - InstantProcessorFunction
      - Arn
  SharedLayerArn:
    Description: ARN of Shared Layer
    Value:
      Ref: SharedLayer
  SharedLayerVersion:
    Description: Version of Shared Layer
    Value:
      Ref: SharedLayer.Version
