# Azure Document Intelligence 小白实施指南

> 用最简单的方式理解整个过程

---

## 🎯 我们要做什么？

**简单说**：我们现在用 AWS Textract（一个识别发票的工具）来提取发票金额、店铺名称等信息。但识别效果不太好，所以我们要再加一个 Azure Document Intelligence（另一个识别工具）来对比，看哪个更准。

### 类比理解：
想象你有一个坏了的眼镜 👓（Textract），看不清楚。现在配了一副新眼镜 🕶️（Azure），看看新眼镜能不能看得更清楚。两副眼镜一起用，比较一下，选最好的那个。

---

## 📝 整个计划分3步

### 第1步：测试新工具（今天完成）✅
**任务**：用网页版工具测试 Azure，看看识别效果怎样

**具体操作**：
```
1. 打开网址：https://formrecognizer.appliedai.azure.com/
2. 输入账号密码登录
3. 上传你的3张发票
4. 看看识别结果（店铺名、金额、税等）
5. 记下结果，和现在的 Textract 对比
```

**就像**：试穿新衣服，看看合不合身

### 第2步：把新工具集成到系统（明天部署）
**任务**：把 Azure 工具的代码写入我们的系统

**实际上已经做好了**：
- ✅ 代码已写好（在 `model-analyzer.mjs` 文件里）
- ✅ 配置文件已准备（`.env.example`）
- ✅ 只需要一个命令就能部署

**就像**：衣服已经做好了，只需要穿上身

### 第3步：实际使用测试（明天上午）
**任务**：用 app 上传一张发票，看能不能同时用 Textract 和 Azure 识别

**具体操作**：
```
1. 打开 Yorutsuke app
2. 拖一张发票进去
3. 等待处理完成
4. 查看数据库，看是否有 Azure 的识别结果
5. 对比两个工具的结果
```

**就像**：穿上新衣服出门走一圈，看看舒不舒服

---

## 🔧 技术细节（简化版）

### 我们有什么？
```
Textract （现在用的）  +  Azure （新加的）  +  Nova Pro （还有一个）
    ↓                        ↓                        ↓
  发票识别                 发票识别                 发票识别
  效果一般                 效果更好？               效果不错
```

### 数据流向：
```
你上传发票
    ↓
我们的系统同时调用3个工具
    ↓
Textract：给出结果（现在）
Azure：给出结果（新加）
Nova Pro：给出结果（现在）
    ↓
3个结果都存下来
    ↓
你可以看到3个结果的对比
```

### 秘密是怎么保护的？

**问题**：Azure 需要一个密钥（密码），但不能放在代码里面

**解决方案**：
```
我的电脑上有个隐藏文件：.env（像私人笔记本）
    ↓
里面写着 Azure 的密钥
    ↓
只有我的电脑能看到
    ↓
Git 上传代码时，这个文件被跳过（不上传）
    ↓
其他人看不到密钥，很安全
```

**类比**：你的密码本放在家里，不会带到办公室，也不会在朋友面前打开。

---

## 📋 按顺序做

### 今天（已完成）✅
- [x] 测试 Azure 工具（用网页版）
- [x] 看识别效果怎样
- [x] 决定值不值得加进系统

### 明天上午（准备部署）
- [ ] 设置本地环境变量（复制一个配置文件）
- [ ] 一个命令部署系统
- [ ] 等5分钟

### 明天下午（测试验证）
- [ ] 用 app 上传发票
- [ ] 看 Azure 能否正常工作
- [ ] 对比 Azure vs Textract 效果

---

## 🎁 我们已经给你准备好了什么？

### ✅ 代码
已写好 Azure 识别的功能，在文件：
```
infra/lambda/shared-layer/nodejs/shared/model-analyzer.mjs
```
（不用你写代码！）

### ✅ 配置文件
已准备好配置模板：
```
infra/.env.example    ← 告诉你要填什么
.env.local.example    ← 告诉你要配置什么
```

### ✅ 密钥
已提前给你准备好：
```
Endpoint（地址）: https://rj0088.cognitiveservices.azure.com/
API Key（密钥）: Tgfa5wRNeIhVd... （长密钥）
```

### ✅ 文档
- `AZURE_DI_DEPLOYMENT.md` ← 部署步骤
- `AZURE_DI_QUICK_START.md` ← 快速开始
- `AZURE_DOCUMENT_INTELLIGENCE.md` ← 详细说明

---

## 🚀 部署其实就3行命令

```bash
# 1. 进入项目文件夹
cd infra/

# 2. 设置环境变量（密钥）
export AZURE_DI_ENDPOINT=https://rj0088.cognitiveservices.azure.com/
export AZURE_DI_API_KEY=<REDACTED_SECRET>

# 3. 开始部署
npm run deploy --context env=dev --profile dev
```

**就是这样！**

---

## ❓ 常见问题

### Q: 为什么要加 Azure？
**A**: Textract 识别效果不稳定（有时候识别不出店铺名、金额错），Azure 可能更准。我们加上它，对比一下，看哪个更好。

### Q: 会影响现有功能吗？
**A**: 不会。Azure 只是额外加的，即使失败了，系统也能正常工作。你的发票还是能识别。

### Q: 密钥安全吗？
**A**: 安全。密钥保存在你的电脑上，不会上传到网上。Git 会自动跳过 `.env` 文件。

### Q: 部署要多久？
**A**: 大概5-10分钟。会看到一堆日志信息，都是正常的。

### Q: 识别结果怎么看？
**A**: 上传发票后，数据库里的 `modelComparison` 字段会有3个结果：
```json
{
  "textract": { ... },      // 旧工具
  "nova_pro": { ... },      // 其他工具
  "azure_di": { ... }       // 新工具
}
```

### Q: Azure 失败了怎么办？
**A**: 不用担心。如果 Azure 出问题，系统会自动用其他工具，你的发票识别不会受影响。

### Q: 以后怎么用？
**A**: 如果 Azure 效果好，我们可以只用 Azure，舍弃 Textract。如果不好，就回到原来的方式。

---

## 📊 3个工具对比

| 工具 | 现在的效果 | Azure效果 | 优势 |
|------|----------|---------|------|
| **Textract** | 50-70% 准确率 | 不知道，要测 | 便宜 |
| **Nova Pro** | 80-90% 准确率 | 不知道，要测 | 速度快 |
| **Azure** | 还没用 | 要测试 | 专业发票识别 |

---

## 🎓 学到的东西

### 关于部署
- 实际部署就一个命令，不复杂
- 密钥安全很重要，不能硬编码

### 关于系统设计
- 同时调用多个 API 对比结果
- 一个失败了，其他的继续工作（容错）
- 数据库里保存所有结果，便于分析

### 关于开发流程
- 测试新功能前，先搭建测试环境
- 部署前确保代码没问题
- 文档很重要，帮助别人快速理解

---

## ✅ 总结（5句话说完）

1. **目标**：加一个新的发票识别工具（Azure），看效果怎样
2. **现状**：代码已写好，配置已准备，只需部署
3. **部署**：一个命令搞定，5分钟完成
4. **测试**：上传发票看结果，对比 Azure vs Textract
5. **结果**：决定要不要用 Azure 替换 Textract

---

## 🗂️ 文件位置速查

```
我要...                              看这个文件
─────────────────────────────────────────────────────
了解 Azure 是什么                    AZURE_DOCUMENT_INTELLIGENCE.md
快速开始测试                         AZURE_DI_QUICK_START.md
部署到服务器                         AZURE_DI_DEPLOYMENT.md
看代码怎么写的                       model-analyzer.mjs
看系统架构决定                       docs/architecture/ADR/013-...
```

---

**就是这样，小白也能理解了！** 🎉

有问题的话，可以看`AZURE_DI_QUICK_START.md`，那里有更详细的步骤。

