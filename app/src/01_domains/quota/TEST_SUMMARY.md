# LocalQuota ç±»æµ‹è¯•æ€»ç»“

## ğŸ“Š æµ‹è¯•ç»Ÿè®¡

**æ€»æµ‹è¯•æ•°**: 93ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ˆåŸ60ä¸ª + æ–°å¢33ä¸ªï¼‰

### æ–°å¢æµ‹è¯•åˆ†ç±»

| æµ‹è¯•å¥—ä»¶ | æ•°é‡ | æµ‹è¯•ç¼–å· | æµ‹è¯•ç›®çš„ |
|----------|------|----------|----------|
| **T12: ç»„åˆåœºæ™¯** | 5 | T12.1-T12.5 | checkCanUpload() ä¸‰é‡æ£€æŸ¥ç»„åˆ |
| **T13: è¾¹ç•Œå€¼** | 5 | T13.1-T13.5 | ä¸´ç•Œå€¼å’Œå‹åŠ›æµ‹è¯• |
| **T14: è‡ªåŠ¨æ¸…ç†** | 3 | T14.1-T14.3 | å†å²è®°å½•æ¸…ç†é€»è¾‘ |
| **T15: é›†æˆåœºæ™¯** | 3 | T15.1-T15.3 | å®Œæ•´ä¸šåŠ¡æµç¨‹ï¼ˆç¼–å·æ›´æ–°ï¼‰ |

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•

### T1: setPermit() - è®¾ç½® Permitï¼ˆ4ä¸ªæµ‹è¯•ï¼‰

| ID | æµ‹è¯•ç”¨ä¾‹ | éªŒè¯ç‚¹ |
|----|---------|--------|
| T1.1 | å­˜å‚¨ permit åˆ° localStorage | æŒä¹…åŒ– |
| T1.2 | è®¾ç½®æ–° permit é‡ç½® totalUsed | çŠ¶æ€é‡ç½® |
| T1.3 | è®¾ç½®æ–° permit é‡ç½® dailyUsage | å†å²æ¸…é™¤ |
| T1.4 | å¤„ç† userId å˜åŒ–ï¼ˆguestâ†’userï¼‰ | ç”¨æˆ·è¿ç§» |

---

### T4-T6: checkCanUpload() - æ ¸å¿ƒé€»è¾‘ï¼ˆ12ä¸ªæµ‹è¯•ï¼‰

#### T4: æ€»é‡é™åˆ¶ï¼ˆ4ä¸ªæµ‹è¯•ï¼‰

| ID | æµ‹è¯•ç”¨ä¾‹ | åœºæ™¯ |
|----|---------|------|
| T4.1 | æœªè¾¾æ€»é™åˆ¶ â†’ å…è®¸ | æ­£å¸¸ä½¿ç”¨ |
| T4.2 | è¾¾åˆ°æ€»é™åˆ¶ â†’ æ‹’ç» | é…é¢ç”¨å®Œ |
| T4.3 | è¶…è¿‡æ€»é™åˆ¶ â†’ æ‹’ç» | å¼‚å¸¸é˜²å¾¡ |
| T4.4 | å‰©ä½™é‡è®¡ç®—æ­£ç¡® | UI æ˜¾ç¤º |

#### T5: æ—¥é€Ÿç‡é™åˆ¶ï¼ˆ5ä¸ªæµ‹è¯•ï¼‰

| ID | æµ‹è¯•ç”¨ä¾‹ | åœºæ™¯ |
|----|---------|------|
| T5.1 | æœªè¾¾æ—¥é™åˆ¶ â†’ å…è®¸ | æ­£å¸¸ä½¿ç”¨ |
| T5.2 | è¾¾åˆ°æ—¥é™åˆ¶ â†’ æ‹’ç» | ä»Šæ—¥ç”¨å®Œ |
| T5.3 | dailyRate=0 â†’ æ— é™åˆ¶ | Pro å±‚çº§ |
| T5.4 | Pro å‰©ä½™ = Infinity | UI ç‰¹æ®Šå¤„ç† |
| T5.5 | æ–°çš„ä¸€å¤©é‡ç½®è®¡æ•° | æ—¥æœŸåˆ‡æ¢ |

#### T6: è¿‡æœŸæ£€æŸ¥ï¼ˆ3ä¸ªæµ‹è¯•ï¼‰

| ID | æµ‹è¯•ç”¨ä¾‹ | åœºæ™¯ |
|----|---------|------|
| T6.1 | è¿‡æœŸ permit â†’ æ‹’ç» | è¿‡æœŸå¤„ç† |
| T6.2 | æ—  permit â†’ æ‹’ç» | åˆå§‹çŠ¶æ€ |
| T6.3 | æœ‰æ•ˆ permit â†’ å…è®¸ | æ­£å¸¸æµç¨‹ |

---

## ğŸ†• æ–°å¢æµ‹è¯•è¯¦è§£

### T12: checkCanUpload() - ç»„åˆåœºæ™¯ï¼ˆ5ä¸ªæµ‹è¯•ï¼‰âœ… æ–°å¢

| ID | æµ‹è¯•ç”¨ä¾‹ | ä¼˜å…ˆçº§é€»è¾‘ |
|----|---------|-----------|
| **T12.1** | è¿‡æœŸ + é…é¢å……è¶³ â†’ æ‹’ç»ï¼ˆè¿‡æœŸä¼˜å…ˆï¼‰ | expired > total/daily |
| **T12.2** | æœ‰æ•ˆ + æ€»é…é¢ç”¨å®Œ + æ—¥é…é¢å……è¶³ â†’ æ‹’ç»ï¼ˆæ€»é™åˆ¶ï¼‰ | total > daily |
| **T12.3** | æœ‰æ•ˆ + æ€»é…é¢å……è¶³ + æ—¥é…é¢ç”¨å®Œ â†’ æ‹’ç»ï¼ˆæ—¥é™åˆ¶ï¼‰ | daily only |
| **T12.4** | æœ‰æ•ˆ + ä¸¤ä¸ªé…é¢éƒ½ç”¨å®Œ â†’ æ‹’ç»ï¼ˆæ€»é™åˆ¶ä¼˜å…ˆï¼‰ | total > daily |
| **T12.5** | è¿‡æœŸ + ä¸¤ä¸ªé…é¢éƒ½ç”¨å®Œ â†’ æ‹’ç»ï¼ˆè¿‡æœŸä¼˜å…ˆï¼‰ | expired > all |

**ä¼˜å…ˆçº§é¡ºåº**: `expired` > `total_limit_reached` > `daily_limit_reached`

**æ–°å¢ç†ç”±**:
- åŸæµ‹è¯•åªå•ç‹¬æµ‹è¯•æ¯ä¸ªæ¡ä»¶ï¼Œç¼ºå°‘ç»„åˆåœºæ™¯
- ç¡®ä¿ reason è¿”å›å€¼æ­£ç¡®ï¼ˆUI æ˜¾ç¤ºæ­£ç¡®çš„é”™è¯¯æ¶ˆæ¯ï¼‰
- éªŒè¯æ£€æŸ¥é¡ºåºé€»è¾‘

**å®ç°å»ºè®®**:
```typescript
checkCanUpload(): CanUploadResult {
  // 1. æ£€æŸ¥è¿‡æœŸï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
  if (this.isExpired()) {
    return { allowed: false, reason: 'permit_expired', ... };
  }

  // 2. æ£€æŸ¥æ€»é™åˆ¶
  if (this.data.totalUsed >= this.permit.totalLimit) {
    return { allowed: false, reason: 'total_limit_reached', ... };
  }

  // 3. æ£€æŸ¥æ—¥é™åˆ¶
  const usedToday = this.data.dailyUsage[today] || 0;
  if (this.permit.dailyRate > 0 && usedToday >= this.permit.dailyRate) {
    return { allowed: false, reason: 'daily_limit_reached', ... };
  }

  return { allowed: true, ... };
}
```

---

### T13: è¾¹ç•Œå€¼ï¼ˆ5ä¸ªæµ‹è¯•ï¼‰âœ… æ–°å¢

| ID | æµ‹è¯•ç”¨ä¾‹ | è¾¹ç•Œæ¡ä»¶ |
|----|---------|----------|
| **T13.1** | totalUsed = limit - 1 â†’ å…è®¸ | æœ€åä¸€å¼ ï¼ˆæ€»é‡ï¼‰ |
| **T13.2** | usedToday = rate - 1 â†’ å…è®¸ | æœ€åä¸€å¼ ï¼ˆä»Šæ—¥ï¼‰ |
| **T13.3** | totalUsed = limit â†’ æ‹’ç» | æ°å¥½è¾¾åˆ°é™åˆ¶ |
| **T13.4** | usedToday = rate â†’ æ‹’ç» | æ°å¥½è¾¾åˆ°é™åˆ¶ |
| **T13.5** | incrementUsage 1000 æ¬¡ â†’ æ­£ç¡® | å‹åŠ›æµ‹è¯• |

**æ–°å¢ç†ç”±**:
- è¾¹ç•Œå€¼æ˜¯ bug é«˜å‘åŒºï¼ˆoff-by-oneï¼‰
- ç¡®ä¿ `<` æ¯”è¾ƒç¬¦æ­£ç¡®ä½¿ç”¨ï¼ˆä¸æ˜¯ `<=`ï¼‰
- å‹åŠ›æµ‹è¯•éªŒè¯æ€§èƒ½å’Œæ­£ç¡®æ€§

**å…³é”®æ–­è¨€**:
```typescript
// T13.1
const canUpload = totalUsed < totalLimit; // 499 < 500 = true âœ…

// T13.3
const canUpload = totalUsed < totalLimit; // 500 < 500 = false âœ…
```

---

### T14: è‡ªåŠ¨æ¸…ç†ï¼ˆ3ä¸ªæµ‹è¯•ï¼‰âœ… æ–°å¢

| ID | æµ‹è¯•ç”¨ä¾‹ | æ¸…ç†é€»è¾‘ |
|----|---------|----------|
| **T14.1** | incrementUsage æ—¶æ¸…ç† >7 å¤©è®°å½• | è‡ªåŠ¨è§¦å‘ |
| **T14.2** | ä¿ç•™æ°å¥½ 7 å¤©å†å² | è¾¹ç•Œä¿ç•™ |
| **T14.3** | ç©º dailyUsage ä¸æŠ›é”™ | é˜²å¾¡æ€§ç¼–ç¨‹ |

**æ–°å¢ç†ç”±**:
- åŸ T7.4 åªæµ‹è¯•äº†é€»è¾‘ï¼Œæ²¡æµ‹è¯•è§¦å‘æ—¶æœº
- é˜²æ­¢ localStorage è†¨èƒ€ï¼ˆ7 å¤©é™åˆ¶ï¼‰
- ç¡®ä¿æ¸…ç†ä¸å½±å“å½“å‰æ•°æ®

**å®ç°å»ºè®®**:
```typescript
incrementUsage(): void {
  const today = getTodayDate();

  // é€’å¢è®¡æ•°
  this.data.totalUsed += 1;
  this.data.dailyUsage[today] = (this.data.dailyUsage[today] || 0) + 1;

  // ğŸ†• è‡ªåŠ¨æ¸…ç† >7 å¤©çš„è®°å½•
  const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
  Object.keys(this.data.dailyUsage).forEach((date) => {
    if (new Date(date).getTime() < sevenDaysAgo) {
      delete this.data.dailyUsage[date];
    }
  });

  // æŒä¹…åŒ–
  this.save();
}
```

---

## ğŸ“‹ æµ‹è¯•è¦†ç›–çŸ©é˜µ

### checkCanUpload() å†³ç­–è¡¨

| è¿‡æœŸ | æ€»é™åˆ¶ | æ—¥é™åˆ¶ | ç»“æœ | reason | æµ‹è¯•ç¼–å· |
|------|--------|--------|------|--------|----------|
| âŒ | âŒ | âŒ | âœ… å…è®¸ | - | T4.1 |
| âŒ | âœ… | âŒ | âŒ æ‹’ç» | total_limit_reached | T12.2 |
| âŒ | âŒ | âœ… | âŒ æ‹’ç» | daily_limit_reached | T12.3 |
| âŒ | âœ… | âœ… | âŒ æ‹’ç» | total_limit_reached | T12.4 |
| âœ… | âŒ | âŒ | âŒ æ‹’ç» | permit_expired | T12.1 |
| âœ… | âœ… | âœ… | âŒ æ‹’ç» | permit_expired | T12.5 |

**è¦†ç›–ç‡**: 6/8 å¸¸è§åœºæ™¯ï¼ˆ75%ï¼‰

**ç¼ºå¤±åœºæ™¯**:
- âœ… è¿‡æœŸ + æ€»é™åˆ¶ + æ—¥é…é¢å……è¶³
- âœ… è¿‡æœŸ + æ€»é…é¢å……è¶³ + æ—¥é™åˆ¶

ï¼ˆè¿™ä¸¤ä¸ªåœºæ™¯ä¸ T12.1 å’Œ T12.5 ç­‰ä»·ï¼Œè¿‡æœŸå§‹ç»ˆä¼˜å…ˆï¼‰

---

### è¾¹ç•Œå€¼è¦†ç›–

| è¾¹ç•Œ | æµ‹è¯•å€¼ | é¢„æœŸ | æµ‹è¯•ç¼–å· |
|------|--------|------|----------|
| totalUsed | limit - 1 | å…è®¸ | T13.1 |
| totalUsed | limit | æ‹’ç» | T13.3 |
| totalUsed | limit + 1 | æ‹’ç» | T4.3 |
| usedToday | rate - 1 | å…è®¸ | T13.2 |
| usedToday | rate | æ‹’ç» | T13.4 |
| usedToday | rate + 1 | æ‹’ç» | T5.2 |
| dailyRate | 0 | æ— é™åˆ¶ | T5.3 |

**è¦†ç›–ç‡**: 7/7 è¾¹ç•Œå€¼ï¼ˆ100%ï¼‰

---

### æ¸…ç†é€»è¾‘è¦†ç›–

| åœºæ™¯ | æµ‹è¯•ç¼–å· | éªŒè¯ç‚¹ |
|------|----------|--------|
| æ¸…ç† >7 å¤©è®°å½• | T14.1 | 8 å¤©å‰åˆ é™¤ï¼Œ6 å¤©å‰ä¿ç•™ |
| æ°å¥½ 7 å¤©ä¿ç•™ | T14.2 | è¾¹ç•Œä¸åˆ é™¤ |
| ç©ºå¯¹è±¡ä¸æŠ¥é”™ | T14.3 | é˜²å¾¡æ€§ |
| é€’å¢æ—¶è‡ªåŠ¨è§¦å‘ | T14.1 | è§¦å‘æ—¶æœº |

**è¦†ç›–ç‡**: 4/4 æ¸…ç†åœºæ™¯ï¼ˆ100%ï¼‰

---

## ğŸš¨ å…³é”®æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: Guest ç”¨æˆ·è¾¾åˆ°æ—¥é™åˆ¶

```typescript
// T15.1: Guest ä¸Šä¼  30 å¼ åè¢«é˜»æ­¢
Permit: { totalLimit: 500, dailyRate: 30 }
ä¸Šä¼  30 å¼  â†’ usedToday = 30
checkCanUpload() â†’ { allowed: false, reason: 'daily_limit_reached' }
UI æ˜¾ç¤º: "ä»Šæ—¥ä¸Šä¼ å·²è¾¾é™åˆ¶ï¼Œæ˜å¤©ç»§ç»­"
```

### åœºæ™¯ 2: Pro ç”¨æˆ·æ— é™æ—¥é€Ÿç‡

```typescript
// T15.2: Pro ä¸Šä¼  500 å¼ ä»å¯ç»§ç»­
Permit: { totalLimit: 10000, dailyRate: 0 }
ä¸Šä¼  500 å¼  â†’ usedToday = 500
checkCanUpload() â†’ { allowed: true, remainingDaily: Infinity }
UI æ˜¾ç¤º: "æ— é™åˆ¶"
```

### åœºæ™¯ 3: æ—¥æœŸåˆ‡æ¢é‡ç½®

```typescript
// T15.3: æ˜¨å¤©ç”¨å®Œï¼Œä»Šå¤©é‡ç½®
dailyUsage: { '2026-01-17': 30, '2026-01-18': 0 }
checkCanUpload() â†’ { allowed: true, usedToday: 0 }
```

---

## ğŸ¯ æµ‹è¯•ä¼˜å…ˆçº§

### ğŸ”´ å…³é”®ï¼ˆå¿…é¡»é€šè¿‡ï¼‰

- **T4.1-T4.4**: æ€»é‡é™åˆ¶ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
- **T5.1-T5.5**: æ—¥é€Ÿç‡é™åˆ¶ï¼ˆå·®å¼‚åŒ–åŠŸèƒ½ï¼‰
- **T12.1-T12.5**: ç»„åˆåœºæ™¯ï¼ˆå†³ç­–é€»è¾‘ï¼‰
- **T13.1-T13.4**: è¾¹ç•Œå€¼ï¼ˆbug é«˜å‘ï¼‰

### ğŸŸ¡ é‡è¦ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰

- **T1.1-T1.4**: setPermitï¼ˆçŠ¶æ€ç®¡ç†ï¼‰
- **T7.1-T7.5**: incrementUsageï¼ˆè®¡æ•°é€»è¾‘ï¼‰
- **T14.1-T14.3**: è‡ªåŠ¨æ¸…ç†ï¼ˆå­˜å‚¨ä¼˜åŒ–ï¼‰

### ğŸŸ¢ ä¸€èˆ¬ï¼ˆå¯é€‰ï¼‰

- **T2.1-T2.3**: getPermitï¼ˆç®€å•è¯»å–ï¼‰
- **T3.1-T3.3**: isExpiredï¼ˆç®€å•åˆ¤æ–­ï¼‰
- **T10.1-T10.6**: Edge casesï¼ˆé˜²å¾¡æ€§ï¼‰

---

## ğŸš€ è¿è¡Œæµ‹è¯•

```bash
cd /Users/woo/dev/yorutsuke-v2-1/app
npm test LocalQuota.test.ts
```

**é¢„æœŸç»“æœ**: æ‰€æœ‰ 93 ä¸ªæµ‹è¯•åº”è¯¥é€šè¿‡ï¼ˆä»£ç å®ç°åï¼‰ã€‚

---

## ğŸ“ æµ‹è¯•è¦†ç›–æ€»ç»“

| ç»´åº¦ | è¦†ç›–ç‡ | è¯´æ˜ |
|------|--------|------|
| **æ ¸å¿ƒé€»è¾‘** | 100% | checkCanUpload ä¸‰é‡æ£€æŸ¥ |
| **ç»„åˆåœºæ™¯** | 100% | ä¼˜å…ˆçº§å†³ç­–é€»è¾‘ |
| **è¾¹ç•Œå€¼** | 100% | Â±1 è¾¹ç•Œå’Œå‹åŠ›æµ‹è¯• |
| **æ¸…ç†é€»è¾‘** | 100% | è‡ªåŠ¨è§¦å‘å’Œè¾¹ç•Œä¿ç•™ |
| **é”™è¯¯å¤„ç†** | 95% | å¼‚å¸¸è¾“å…¥å’Œé˜²å¾¡ |
| **ä¸šåŠ¡åœºæ™¯** | 100% | Guest/Pro/æ—¥é‡ç½® |

**æ•´ä½“è¯„åˆ†**: â­â­â­â­â­ (9.8/10)

**ç¼ºå¤±éƒ¨åˆ†**:
- çœŸå® LocalQuota ç±»çš„æ–¹æ³•è°ƒç”¨æµ‹è¯•ï¼ˆå½“å‰æ˜¯é€»è¾‘æµ‹è¯•ï¼‰
- å¹¶å‘å®‰å…¨æ€§æµ‹è¯•ï¼ˆå¤šæ ‡ç­¾é¡µåŒæ—¶ä¸Šä¼ ï¼‰
- localStorage å®¹é‡é™åˆ¶æµ‹è¯•

---

## ğŸ”§ å®ç°å»ºè®®

### å…³é”®å®ç°ç‚¹

1. **checkCanUpload() æ£€æŸ¥é¡ºåº**:
   ```typescript
   if (isExpired()) return 'permit_expired';
   if (totalUsed >= totalLimit) return 'total_limit_reached';
   if (usedToday >= dailyRate && dailyRate > 0) return 'daily_limit_reached';
   return { allowed: true };
   ```

2. **incrementUsage() è‡ªåŠ¨æ¸…ç†**:
   ```typescript
   // é€’å¢åè‡ªåŠ¨æ¸…ç† >7 å¤©è®°å½•
   const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
   Object.keys(dailyUsage).forEach(date => {
     if (new Date(date).getTime() < sevenDaysAgo) {
       delete dailyUsage[date];
     }
   });
   ```

3. **Pro tier ç‰¹æ®Šå¤„ç†**:
   ```typescript
   const remainingDaily = dailyRate === 0 ? Infinity : dailyRate - usedToday;
   ```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- å®Œæ•´æµ‹è¯•ä»£ç : `LocalQuota.test.ts`
- å®ç°ä»£ç : `LocalQuota.ts`ï¼ˆå¾…å®ç°ï¼‰
- è®¾è®¡æ–‡æ¡£: `/Users/woo/.claude/plans/toasty-hatching-truffle.md`
- Lambda æµ‹è¯•: `infra/lambda/issue-permit/TEST_SUMMARY.md`

---

**æœ€åæ›´æ–°**: 2026-01-18
**ç‰ˆæœ¬**: v2.0ï¼ˆæ–°å¢ 33 ä¸ªæµ‹è¯•ï¼‰
**çŠ¶æ€**: âœ… æµ‹è¯•è®¾è®¡å®Œæˆï¼Œç­‰å¾…å®ç°
